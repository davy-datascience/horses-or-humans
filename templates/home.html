<!doctype html>
<html>
  <head>
    <title>File Upload</title>
  </head>
  <body>
    <script language="javascript" type="text/javascript">

      function uploadFile(file, s3Data, url){
        var xhr = new XMLHttpRequest();
        xhr.open("POST", s3Data.url);

        var postData = new FormData();
        for(key in s3Data.fields){
          postData.append(key, s3Data.fields[key]);
        }
        postData.append('file', file);

        xhr.onreadystatechange = function() {
        console.log(JSON.stringify(xhr, undefined, 4));
          if(xhr.readyState === 4){
            if(xhr.status === 200 || xhr.status === 204){
              console.log("ok");
            }
            else{
              alert("Could not upload file.");
              console.log("status: " + xhr.status);
            }
         }
        };
        xhr.send(postData);
      }

      function getSignedRequest(file){
        var xhr = new XMLHttpRequest();
        xhr.open("GET", "/sign_s3?file_name="+file.name+"&file_type="+file.type);
        xhr.onreadystatechange = function(){
          if(xhr.readyState === 4){
            if(xhr.status === 200){
              var response = JSON.parse(xhr.responseText);

              console.log("url: " + response.url);

              uploadFile(file, response.data, response.url);
            }
            else{
              alert("Could not get signed URL.");
            }
          }
        };
        xhr.send();
      }

      window.onload = function () {
          var fileUpload = document.getElementById("fileupload");
          fileUpload.onchange = function () {
              if (typeof (FileReader) != "undefined") {
                  var files = document.getElementById("fileupload").files;
                  var file = files[0];
                  if(!file){
                    return alert("No file selected.");
                  }
                  getSignedRequest(file);

                  var dvPreview = document.getElementById("dvPreview");
                  dvPreview.innerHTML = "";
                  var regex = /^([a-zA-Z0-9\s_\\.\-:])+(.jpg|.jpeg|.gif|.png|.bmp)$/;
                  for (var i = 0; i < fileUpload.files.length; i++) {
                      var file = fileUpload.files[i];
                      if (regex.test(file.name.toLowerCase())) {
                          var reader = new FileReader();
                          reader.onload = function (e) {
                              var img = document.createElement("IMG");
                              img.height = "100";
                              img.width = "100";
                              img.src = e.target.result;
                              dvPreview.appendChild(img);
                          }
                          reader.readAsDataURL(file);
                      } else {
                          alert(file.name + " is not a valid image file.");
                          dvPreview.innerHTML = "";
                          return false;
                      }
                  }
              } else {
                  alert("This browser does not support HTML5 FileReader.");
              }
          }
      };
    </script>

    <h1>File Upload</h1>
    <form method="POST" action="" enctype="multipart/form-data">
      <p><input id="fileupload" type="file" name="file" accept="image/*" multiple></p>
      <br />
      <div id="dvPreview"></div>
      <br />
      <p><input type="submit" value="Submit"></p>
    </form>
  </body>
</html>